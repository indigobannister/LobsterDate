---
title: 'Analysis of Lobster Abundance along the Santa Barbara Coast'
author: "Indigo Bannister & Gavriella Keyles"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r}
# In order to install extrafont, use following code in the console:
## install.packages("extrafont")

# In order to install NPS colors, use following code in the console:
## install.packages("devtools")
## devtools::install_github("katiejolly/nationalparkcolors")

# Attach packages
library(tidyverse)
library(tidyr)
library(here)
library(janitor)
library(ggridges)
# library(viridis)
library(plotly)
library(extrafont)
library(nationalparkcolors)
library(kableExtra)

# Load fonts
loadfonts()

# Read in data file: lobster_abundance_sbc_lter.csv
lobster_abun <- read_csv(here("raw_data","lobster_abundance_sbc_lter.csv"),
                         na = "-99999")

# Clean lobster_abun dataframe: update column names and make data tidy, add column and attribute full site names, factor site_name to group MPAs adjacent to one another
lobster_clean <- lobster_abun %>% 
  clean_names() %>% 
  tidyr::uncount(count) %>% 
    mutate(site_name = 
           ifelse(site == "IVEE", "Isla Vista",
         ifelse(site == "AQUE", "Arroyo Quemado",
         ifelse(site == "CARP", "Carpinteria",
         ifelse(site == "NAPL", "Naples", "Mohawk"))))) %>% 
  mutate(site_name = factor(site_name, levels = c("Isla Vista","Naples","Arroyo Quemado","Carpinteria","Mohawk") ))

```

### Introduction
Gavi to write paragraph here on introduction. 

![<font size="1"> **Figure 1:** California Spiny Lobsters off Anacapa Island. Photographer: [Ed Bierman</font>](https://www.flickr.com/people/26216388@N02).](images/California_Spiny_Lobster.jpg)


### Data & Methods
Data for California spiny lobster abundance and size along the Santa Barbara Coast, 2012-2018, were collected by the [Santa Barbara Coastal Long Term Ecological Research group](https://sbclter.msi.ucsb.edu/). Data was collected annually at five long term kelp forest study sites. Two of the sites were located within Marine Protected Areas (Naples and Isla Vista) and three were outside of a MPA (Arroyo Quemado, Mohawk and Carpinteria). Lobsters were counted and sizes estimated visually by divers in late summer before fishing season began. For more information on the methods, see the project [metadata](https://portal.edirepository.org/nis/metadataviewer?packageid=knb-lter-sbc.77.3).

ADD SOMETHING HERE ABOUT ANALYSIS. Similar to "Mean griffin range area (km2) was compared for pre-dragon (1984 - 2004) and post-dragon (2005 - 2019) periods by two-sample t-tests (Î± = 0.05 throughout). Trends in Griffin abundance were compared before and after dragon reintroduction by linear regression. All analyses and figures were prepared using R software version 3.6.1."

### Results

\

#### 1. Annual lobster abundance by site, 2012-2018
**Analysis:** Figure 2 demonstrates varying trends in lobster abundance among the 5 collection sites. At Isla Vista and Naples, both located within Marine Protected Areas, lobster abundance trends positive after the MPAs were established in 2012. Both MPA sites saw spikes in 2015, and declines in 2016 followed by increases in population. At non-MPA sites, counts are highly variable and characteristics between sites are not shared. At Arroyo Quemado, lobster counts remained relatively stable over the studied time period. At Carpinteria, a major spike in lobster abundance (2017) was followed by a major decline (2018). At Mohawk, a spike in abundance in 2015 gives way to stability into 2018.

```{r}
# Create filtered dataframe for abundance graph
lobster_a <- lobster_clean %>% 
  select(year, site_name) %>% 
  count(year, site_name) %>% 
  rename(annual_total = n)

# Create a custom palette for colors in graph_a
site_colors <- park_palette("Everglades")

# Create graph of lobster abundance from 2012 to 2018
graph_a <- ggplot(lobster_a, aes(color = site_name, x = year, y = annual_total)) +
  geom_line() +
  theme_minimal() +
  scale_color_manual(values = site_colors, name = "Site") +
  labs(
    x = "",
    y = "Total lobsters counted",
    title = "Year-over-year lobster count change", #IB would recommend removing title since we have a figure caption
    subtitle = "Santa Barbara County") +
  theme(plot.title = element_text(hjust = 0.5))+
  scale_x_continuous(limits = c(2012, 2018),
                     expand = c(0,0),
                     breaks = seq(2012, 2018, by = 1)) + 
  scale_y_continuous(breaks = seq(0, 1000, by = 200),
                     expand = c(0,0))

# Make graph_a interactive with ggplotly 
ggplotly(graph_a, tooltip = c("site_name", "y")) %>%
  config(displayModeBar = FALSE)

# This website has lots of resources to customize ggplotly https://plotly-r.com/controlling-tooltips.html 

# IB played around and tried to get more space between years and beginning of graph - have not been able to get there yet. Also in midst of getting all of legend on one line. 
```

<font size="1"> ***Figure 2: Year-over-year change, lobsters counted in 5 Santa Barbara Channel sites, 2012-2018.*** *Annual lobsters counts based on data collected by divers before the start of fishing season in late summer at five sites, two of which (Isla Vista and Naples) are within Marine Protected Areas (MPA).* ***Interactive:*** *double-click on individual site within legend to highlight. Single-click and unclick sites to toggle visibility and compare site data.*</font>

\

#### 2. Lobster size: 2012 to 2018
**Analysis:** Figure 3 depicts size abundance trends amongst lobsters in 2012 and 2018 at the five collection sites. Both sites that established MPAs in 2012 (Isla Vista and Naples) had more larger lobsters by 2018 than they did when the MPAs were established. Median sizes for Isla Vista lobsters increased from MAKE INLINE (61 mm to 78 mm), while median sizes for Naples lobsters increased from MAKE INLINE (70 mm to 80.5 mm).

Lobster sizes at the non-MPA sites stayed relatively stable across the time duration with median sizes not shifting greatly. 


```{r}
# Create two dataframes filtered for size analysis, one for lobster size data in 2012 and the other for 2018
lobster_2018 <- lobster_clean %>% 
  select(year, size_mm, site_name) %>% 
  filter(year %in% c(2018))

lobster_2012 <- lobster_clean %>% 
  select(year, size_mm, site_name) %>% 
  filter(year %in% c(2012))

# Create two dataframes with calculated medians for lobster size in 2012 and 2018 at each site
lobster_2018_med <- lobster_2018 %>% 
  group_by(site_name) %>% 
  summarize(median = median(size_mm))

lobster_2012_med <- lobster_2012 %>% 
  group_by(site_name) %>% 
  summarize(median = median(size_mm))

# Create graph of lobster size distribution for 2012 and 2018 at each site
graph_b <- ggplot() +
  geom_density_ridges(data = lobster_2012, 
                      aes(x = size_mm, y = reorder(site_name, desc(site_name))), 
                      fill = "#2E8289", 
                      color = "white", 
                      alpha = 0.5,
                      scale = 0.9) +
    geom_density_ridges(data = lobster_2018, 
                      aes(x = size_mm, y = reorder(site_name, desc(site_name))), 
                      fill = "#EAAE37",
                      color = "white",
                      alpha = 0.4,
                      scale = 0.9) +
  theme_minimal() +
  labs(x = "Lobster size (mm)",
       y = "Study sites") + 
  scale_x_continuous(limits = c(40,120))+
  annotate("text", x = 115, y = 1.75, label = "2012", color = "#2E8289", fontface = 1.8, size = 4)+
  annotate("text", x = 115, y = 1.25, label = "2018", color = "#EAAE37", fontface = 1.8, size = 4)+
  annotate("text", x = 115, y = 2.15, label = "Legend", color = "black", fontface = 2, size = 4)

# Call graph_b
graph_b

# Talk to Gavi about x-scale 

```

<font size="1"> ***Figure 3: Comparison of distribution of sampled lobster size at five sampling sites, 2012 & 2018***
*Distribution of lobster size at five sampling sites in two different years, 2012 and 2018. Two of the five sites (Isla Vista and Naples) established Marine Protected Areas (MPAs) in 2012. These two sites had more lobsters of larger size in 2018 than in 2012. The other three sites not in MPAs had more consistent size distribution across the two years.* </font>

\

#### 3. Analysis of lobsters in marine protected areas versus non-protected areas
Add description of analysis here. 

```{r}
# Part C

# Cleaning the data, used mutate and ifelse statement to make new MPA status variable. Boom!
lobster_c <- lobster_clean %>% 
  mutate(mpa_status = 
           ifelse(site %in% c("IVEE", "NAPL"), "MPA", "non-MPA"))

# Create dataframes to insert into t-tests for Part C 1 & 2
mpa_size_compare_2012 <- lobster_c %>% 
  select(mpa_status, size_mm, year) %>% 
  filter(year == "2012", mpa_status == "MPA") %>% 
  pull(size_mm)

non_mpa_size_compare_2012 <- lobster_c %>% 
  select(mpa_status, size_mm, year) %>% 
  filter(year == "2012", mpa_status == "non-MPA") %>% 
  pull(size_mm)

mpa_size_compare_2018 <- lobster_c %>% 
  select(mpa_status, size_mm, year) %>% 
  filter(year == "2018", mpa_status == "MPA") %>% 
  pull(size_mm)

non_mpa_size_compare_2018 <- lobster_c %>% 
  select(mpa_status, size_mm, year) %>% 
  filter(year == "2018", mpa_status == "non-MPA") %>% 
  pull(size_mm)

# Run t-tests for 2012 and 2018 in MPA vs. non-MPA
size_ttest_2012 <- t.test(mpa_size_compare_2012, non_mpa_size_compare_2012)

size_ttest_2012

size_ttest_2018 <- t.test(mpa_size_compare_2018, non_mpa_size_compare_2018)

size_ttest_2018

## Run t-tests for MPA and non-MPA for 2012 vs. 2018
ttest_MPA <- t.test(mpa_size_compare_2012, mpa_size_compare_2018)

ttest_MPA

ttest_nonMPA <- t.test(non_mpa_size_compare_2012, non_mpa_size_compare_2018)

ttest_nonMPA
  


```

```{r}
# Part C continued - create table of results

# Create table of summary stats
lobster_sum <- lobster_c %>% 
  filter(year %in% c(2012, 2018)) %>% 
  group_by(year, mpa_status) %>%
  summarize(mean = round(mean(size_mm),2),
            std_dev = round(sd(size_mm),2), 
            samp_size = n())

lobster_sum %>% 
  kable(col.names = c("Year", 
                     "MPA Status", 
                     "Mean (mm)",
                     "Standard Deviation (mm)",
                     "Sample Size")) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = F,
                position = "left"
                )


```
INDIGO TO ADD TABLE HEADER
GAVI TO ADD INLINE REFERENCES

\

### Summary (INDIGO)

\

### References
**Reed D. 2019.** [SBC LTER: Reef: Abundance, size and fishing effort for California Spiny Lobster (Panulirus interruptus), ongoing since 2012.](https://doi.org/10.6073/pasta/a593a675d644fdefb736750b291579a0) Environmental Data Initiative. Dataset accessed 10/30/2019.
